\documentclass[12pt, letterpaper]{report}
\usepackage{fancyhdr}
\usepackage{hyperref}
\usepackage{wrapfig}
\usepackage{subcaption}
\usepackage{graphicx}
\usepackage{multicol}
\usepackage{blindtext}
\usepackage{amsmath}
\usepackage{float}
\usepackage{listings}
\usepackage{xcolor}
\usepackage[margin=1.5cm]{geometry}

\usepackage[english,polish]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{dirtree}


\graphicspath{ {images/} {images/collisions24x10_2x2} }

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{codelistingstyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=codelistingstyle}

\title{
    Praca magisterska \\
    \large Modelowanie elastycznych i nieelastycznych
    zderzeń obiektów\\
    metodą dynamiki molekularnej na potrzeby animacji
    komputerowych
}
\author{
    Kamil Pasterczyk \\
    \small Promotor: dr hab. inż. Tomasz Chwiej
}

\begin{document}

\maketitle
\tableofcontents

\chapter{Wstęp}
    \section{Cele projektu}
    Jedną z popularnych metod wykorzystywanych w modelowaniu zderzeń obiektów w mikro- i makroskali jest 
    metoda dynamiki molekularnej. Mimo iż w pierwotnej postaci stosowana była do opisu własności gazów i 
    cieczy, to dzięki swej wszechstronności pozwala modelować obiekty makroskopowe zachowujące kształt 
    przy braku sił zewnętrznych oraz modelować ich rozrywanie w trakcie zderzeń z innymi obiektami. W pracy 
    należy zaadoptować odpowiednio sparametryzowany model dynamiki molekularnej i na jego podstawie opracować 
    algorytmy numeryczne do symulacji zderzeń obiektów z możliwością penetracji lub rozrywania jednego z nich. 
    Algorytmy powinny być zaimplementowany na tyle wydajne aby możliwa była wizualizacja zderzeń w czasie 
    rzeczywistym jako animacje komputerowe.

    \section{Generowanie grafiki}
    Do generowania grafiki i animacji zostało wykorzystane API OpenGL w profilu rdzennym (core profile), 
    pozwalającym samodzielnie programować shadery \cite{grafika3d} (strona 13). \\

    W nowoczesnym OpenGL potok renderowania składa się z \cite{grafika3d} (strona 72):
    \begin{enumerate}
        \item Stworzenia buforów na werteksy i indeksy.
        \item W shaderze werteksów przekształcenia położeń werteksów 
        za pomocą macierzy rzutowania i ustalenia koloru dla każdego werteksu.
        \item Przycinanie i rasteryzacja.
        \item Shader fragmentów wykonuje operacje na pikselach mających na celu 
        ustalenie ostatecznego koloru dla każdego piksela.
        \item Test głębi, blending.
    \end{enumerate}

    Macierz rzutowania odpowiada za transformację z układu współrzędnych kamery do układu przycinania 
    (clip coordinate system) \cite{grafika3d} (strona 139). W aplikacji używana jest do zmiany położenia 
    obecnie obserwowanego miejsca oraz przybliżanie i oddalanie kamery. Ponieważ przestrzeń po której porusza się
    kamera jest dwuwymiarowa, macierz taka ma wymiary $3 \times 3$.

    Istotną optymalizacją było instanced rendering, metoda pozwalająca na renderowanie wielu obiektów na raz 
    przy użyciu jednego draw call. Najpierw należy zainicjalizować geometrię obiektu który będzie renderowany, 
    następnie stworzyć tablicę zwierającą informację między innymi o położeniu każdego z tych obiektów. W ten sposób
    zamiast renderowania każdego obiektu w osobnym draw call, można renderować wszystkie obiekty w jednym draw call.

    % --------------------------------------------------------------------------------------------------------------
    \section{Zastosowane technologie}

    Najważniejszym narzędziem wykorzystamy do stworzenia aplikacji jest \emph{rust}, szybki kompilowany 
    język programowania zapewniający bezpieczeństwo pamięci i łatwe programowanie wielowątkowe. 
    Język ten jest wybierany co roku zaczynając od roku 2015 w ankiecie społeczności \emph{Stack Overflow} jako 
    \emph{``the most beloved programming language''}. O ile jest on wymagający, to jest 
    on również wygodny, kod jest prosty do zrozumienia a programy napisane z jego użyciem 
    można łatwo kompilować na wielu systemach nawet jeżeli używają one zewnętrznych bibliotek, gdyż 
    zależności są zarządzane przez narzędzie \emph{cargo}, będące nieodzowną częścią ekosystemu tego języka.

    Kompilator \emph{rustc} jest restrykcyjny, ponieważ wymusza on na kodzie programu bezpieczeństwo pamięci oraz
    nie zezwala na kod generujący niezdefiniowane zachowanie, będące częstym problemem podczas tworzenia aplikacji
    wielowątkowych. ``Rust breaks down these barriers by eliminating the old pitfalls and providing a friendly, 
    polished set of tools to help you along the way'' - \cite{rustbook} (strona 1)

    Restrykciność kompilatora nie jest poważnym problemem prodczas towrzenia aplikacji, ponieważ 
    kompilator dostarcza dokładnego opisu błędu wraz z referencją do dokumentacji a często również 
    sugeruje sposób jego poprawiania. \\

    Do wyświetlenia interfejsu graficznego, pozwalającego monitorowanie oraz kontrolowanie stanu symulacji  
    wykorzystana została biblioteka \emph{eGui} \cite{egui}. Jest ona kompatybilna z językiem \emph{rust} 
    i API \emph{OpenGL}, dostarcza możliwości wyświetlania okienek wraz z elementami wejścia (przyciski, suwaki). \\

    Na potrzeby zrównoleglenia kodu symulacji wykorzystana została biblioteka \emph{rayon} \cite{rayon}, służąca
    do programowania wielowątkowego w języku \emph{rust} z wykorzystaniem współdzielenia pamięci. 
    Jest to odpowiednik API \emph{OpenMP} ze środowiska wykorzystywanego w 
    programach napisanych w \emph{C} lub \emph{C++}. \\
    
    Do wyświetlania animacji wykorzystane zostało API \emph{OpenGL} w profilu rdzennym (core profile), w projekcie
    udostępnione przez bibliotekę \emph{glium}. Nie jest ono już rozwijane, ostatnia stabilna wersja 
    \emph{OpenGL 4.6} pojawiła się w roku 2017, jednak jego możliwości są w pełni wystarczające
    na potrzeby projektu. Główne zasady tworzenia programu są takie same jak w nowocześniejszych rozwiązaniach 
    takich jak \emph{Vulkan}, jednak samo API jest nieco łatwiejsze w użyciu i pozwala osiągnąć zamierzone 
    dla tej aplikacji efekty w mniejszej liczbie linijek kodu. \\
    
    Do wykonania symulacji na procesorze graficznym wykorzystane zostało API \emph{OpenCL}, jest ono kompatybilne
    z większością obecnie wykorzystywanych systemów operacyjnych i działa ono na sprzętach różnych producentów, 
    w przeciwieństwie do technologii \emph{Cuda}, obsługującej jedynie procesory graficzne \emph{Nvidia}.
    
    % --------------------------------------------------------------------------------------------------------------
    \section{Architektura projektu}
    Projekt posiada dwa pliki wykonywalne, jeden służy jako pomoc do generowania scen, które zapisywane są 
    do plików. Drugi plik jest wykonywalny po podaniu ścieżki do pliku zawierającego scenę wyświetla ją, 
    udostępnia interfejs i pozwala na wykonywanie i monitorowanie symulacji.

    \subsection{Struktura repozytorium}
    \dirtree{%
        .1 elastic-objects-rs.
        .2 data.
        .2 doc.
        .3 code.
        .3 images.
        .2 glsl.
        .2 scenes.
        .2 src.
        .3 bin.
        .3 kernels.
        .3 scene.
        .3 simulation.
    }

    Folder \emph{src} zawiera główny kod źródłowy programu. 
    
    Znajduje się w nim folder \emph{bin} zawierający pliki wykonywalne, jeden służący do generowania scen, drugi do wykonywania symulacji. 
    
    Wygenerowane stany symulacji domyślnie zapisywane i czytane są z folderu \emph{scenes}. 
    
    W folderze \emph{kernels} znajduje się kod wykorzystywany przez \emph{OpenCL} do wykonywania symulacji na procesorze graficznym. 
    
    Pliki generowane przez symulację zapisywane są w folderze \emph{data}. Są to logi zawierające informacje o stanie energii
    symulacji w danych chwilach czasowych.
    
    W folderze \emph{glsl} znajdują się kod shaderów wykorzystywanych do rysowania stanu symulacji.

    
    % --------------------------------------------------------------------------------------------------------------
    \section{Napotkane problemy i próby ich rozwiązania}
    Podstawowym problemem jest wydajność, najpierw każdy węzeł był rysowany osobno ale to podejście 
    było zbyt wolne. Następnie przy użyciu instanced rendering problem ten został zlikwidowany po 
    stronie interfejsu graficznego.
    
    Następnym problemem była wydajność symulacji,
    
    Wielowątkowość jest trudna do osiągnięcia, wymaga znacznej modyfikacji algorytmów.
    
    % --------------------------------------------------------------------------------------------------------------
    \section{Wielowątkowość}
    (OpenMP) Wątki charakteryzują się współdzieleniem pamięci operacyjnej, co może prowadzić to problemów, takich jak nadpisywanie.
    (MPI) Procesy posiadają swoją oddzielną pamięć, dlatego synchronizacja przebiega w inny sposób, taki jak message passing.
    (CUDA) To podejście hybrydowe (bloki, warps, wątki)  \cite{cuda} (strona 23)

    ``If you can construct a formula where the output data points can be represented without 
    relation to each other (...) be very happy'' - \cite{cuda} (strona 24)
    
    ``Computing has (...) moved from one limited by computational throughput of the 
    processor, to one where moving the data is the primary limiting factor'' - \cite{cuda} (strona 25)
    
    % --------------------------------------------------------------------------------------------------------------
    \section{Model oddziaływań}
    Potencjał Lennarda-Jonesa został wykorzystany do symulacji przyciągania/odpychania 
    węzłów w jednym obiekcie, symulacji kolizji węzłów ze ścianami oraz symulacji
    kolizji węzłów z węzłami należącymi do innych obiektów. 
    Potencjał ten opisany jest za pomocą poniższego równania:
    \begin{equation}
        E_{LJ} = V_0 \left[ \left( \frac{\sigma}{l} \right)^{12} - \left( \frac{\sigma}{l} \right)^{6} \right]
    \end{equation}
    \begin{equation}
        \sigma = \frac{d_0}{\sqrt[6]{2}}
    \end{equation}
    Gdzie $l$ to odległość między dwiema oddziałującymi cząstkami, $V_0$ to współczynnik określający wielkość potencjału 
    a $\sigma$ to odległość, przy której energia potencjalna oddziaływania pomiędzy cząsteczkami wynosi zero. 
    Potencjał Lennarda-Jonesa ma swoje minimum w odległości $d_0 = \sqrt[6]{2} \sigma$. \\ \\
    Siła zdefiniowana jest jako pochodna energii:
    \begin{equation}
        F_{LJ} = 
        \frac{d}{dl} E_{LJ} = 
        \frac{d}{dl} V_0 \left[ \left( \frac{\sigma}{l} \right)^{12} - \left( \frac{\sigma}{l} \right)^{6} \right]
    \end{equation}
    \begin{align*}
        F_{LJ} &= \frac{d}{dl} V_0 \left[ \sigma^{12}l^{-12} - \sigma^{6}l^{-6} \right] =\\
        &= V_0 \left[ \sigma^{12}(-12)l^{-13} - \sigma^{6}(-6)l^{-7} \right] =\\
        &= V_0 \left[ 6\sigma^{6}l^{-7} - 12\sigma^{12}l^{-13} \right] =\\
        &= V_0 \left[ 6 \left(\frac{d_0}{\sqrt[6]{2}}\right)^{6} l^{-7} - 12 \left(\frac{d_0}{\sqrt[6]{2}}\right)^{12} l^{-13} \right] =\\
        &= 3 V_0 \left[ 2 \left(\frac{d_0}{\sqrt[6]{2}}\right)^{6} l^{-7} - 4 \left(\frac{d_0}{\sqrt[6]{2}}\right)^{12} l^{-13} \right] =\\
        &= 3 V_0 \left[ (d_{0})^{6} l^{-7} - (d_{0})^{12} l^{-13} \right] =\\
        &= 3 \frac{V_0}{d_0} \left[ (d_{0})^{7} l^{-7} - (d_{0})^{13} l^{-13} \right] =\\
        &= 3\frac{V_0}{d_0} \left[ \left(\frac{d_0}{l}\right)^{7} - \left(\frac{d_0}{l}\right)^{13} \right]
    \end{align*}
    W ten sposób otrzymaliśmy wzór opisujący siłę wynikającą z potencjału Lennarda-Jonesa:
    \begin{equation}
        F_{LJ} = 3\frac{V_0}{d_0} \left[ \left(\frac{d_0}{l}\right)^{7} - \left(\frac{d_0}{l}\right)^{13} \right]
    \end{equation}

    % --------------------------------------------------------------------------------------------------------------
    \section{Temperatura z teorii gazów}
    \subsection{Opis metody}
    Punktem wyjścia może być zasada ekwipartycji energii: średnia energia kinetyczna na jeden stopień swobody jest równa 
    $\frac{k_{B}T}{2}$ gdzie $k_{B}$ to stała Boltzmanna a $T$ to temperatura.

    \begin{equation}
        \left< E_{k} \right> = s \frac{k_{B}T}{2}
    \end{equation}

    W naszym przypadku liczba stopni swobody $s = 2$ (ruch translacyjny w dwóch osiach $x$ i $y$).

    \begin{align*}
        \left< E_{k} \right> = \left< \frac{m v^{2}}{2} \right> = \frac{m}{2} \left< v^{2} \right> = T \frac{k_{B}}{2}
    \end{align*}

    \begin{equation}
        T = \frac{m}{k_{B}} \left< v^{2} \right>
    \end{equation}

    Wzór wzięty z teorii kinetyczno-molekularnej gazów.

    \subsection{Weryfikacja poprawności wzoru}
    Rozważmy przypadek gdy obiekt porusza się w przestrzeni jako całość: swobodny spadek w polu grawitacyjnym.
    Węzły nie drgają i przemieszczają się z tą samą prędkością 
    $\vec{V_k} = \vec{V_0} + \vec{g}t$ dla $t > 0  \Rightarrow  |\vec{V_k}|^2  \Rightarrow  T > 0$ a 
    przecież swobodny spadek nie rozgrzewa ciał. 
    Wniosek: ten wzór jest nieodpowiedni dla naszego modelu, należy go zmodyfikować.
    
    \subsection{Modyfikacja wzoru}
    Należy przeskalować prędkość, to znaczy odjąć średnią prędkość z jaką porusza się obiekt jako całość, wówczas nie będzie
    to prowadziło dodatkowego wzrostu temperatury. Def: $\left< v^{2} \right>  =  \frac{1}{T} \int_{0}^{T} v^2(t) dt$
    uśredniony po krótkich odcinkach czasu. Estymator $\left< v^{2} \right>$ to średnia arytmetyczna: 
    $t = t_i = i \cdot \Delta t$ dla $i = 0, 1, ..., n-1$.

    \begin{equation}
        \left< v^{2} \right>  \approx  \overline{v^2} = \frac{1}{n \cdot \Delta t} \sum_{i = 0}^{n} {v_i}^2 \Delta t
        = \frac{1}{n} \sum_{i = 0}^n {v_i}^2
    \end{equation}

    Modyfikujemy wzór odejmując wartość średnią:
    \begin{align*}
        \left< \left( v - \left< v \right> \right)^2 \right>  &=  
        \frac{1}{T} \int_{0}^{T} \left( v(t) - \left< v \right> \right)^2 dt  \\
        &= \frac{1}{T} \int_{0}^{T} \left( v^2(t) - 2v \left< v \right> + \left< v \right>^2 \right) dt  \\
        &= \frac{1}{T} \int_{0}^{T} v^2 \, dt - 2 \left< v \right> \frac{1}{T} \int_{0}^{T} v \, dt + \left< v \right>^2 
        + \left< v \right>^2 \frac{1}{T} \int_{0}^{T} dt \\
        &= \left< v^2 \right> - 2 \left< v \right> \cdot \left< v \right> + \left< v \right>^2 \\
        &= \left< v^2 \right> - \left< v \right>^2
    \end{align*}

    Uzyskany wynik to wariancja prędkości:
    \begin{equation}
        {\delta_v}^2  =  \left< \left( v - \left< v \right> \right)^2 \right>  =  \left< v^2 \right> - \left< v \right>^2
    \end{equation}

    Estymator wariancji:
    \begin{equation}
        {\delta_v}^2  \approx  \frac{1}{n} \sum_{i = 0}^{n - 1} {v_i}^2 - \left( \frac{1}{n} \sum_{i = 0}^{n - 1} {v_i} \right)^2
    \end{equation}

    \subsection{Weryfikacja zmodyfikowanego wzoru}
    Ponownie rozparzymy spadek swobodny dla jednego wymiaru: $v_k = v_0 + gt$ gdzie $v_0 = 0 = v_k = gt$

    \begin{align*}
        {\delta_v}^2  &=
        \left< v^2 \right> - \left< v \right>^2 \\ 
        &=  \frac{1}{T} \int_{0}^{T} g^2 t^2 \, dt  -  \left( \frac{1}{T} \int_{0}^{T} g \cdot t \, dt \right)^2  \\
        &=  g^2 \frac{1}{T} \frac{T^3}{3}  -  \left( g \frac{1}{T} \frac{T^2}{2} \right)^2  = \frac{g^2 T^2}{3}  -  \frac{g^2 T^2}{4} \\
        &=  \frac{g^2 T^2}{12}
    \end{align*}

    \begin{equation}
        {\delta_v}^2  =  \frac{g^2 T^2}{12}
    \end{equation}

    Z powyższych obliczeń wynikia, że temperatura wciąż wzrasta podczas swobodnego spadku. 
    Jeżeli jednak $a >> g$ to wpływ na temperaturę jest niewielki a dla $T << 1$ oraz $a >> g$ 
    np. $a = 5 \cdot g \Rightarrow {\delta_{v_a}}^2 = 25 \cdot {\delta_{v_g}}^2$ \\

    Ze względu na powyżej przedstawione problemy oraz trudną implementację, metoda ta nie została wykorzystana
    w dalszej części pracy.

    % --------------------------------------------------------------------------------------------------------------
    \section{Temperatura z twierdzenia o wiriale}
    \subsection{Opis metody}
    Prędkości węzłów zmieniają się w czasie, więc będzie też zmieniać się średnia energia kinetyczna układu.

    \begin{equation}
        \left< E_{kinetyczna} \right>  =  \left< \sum_{k = 1}^{N_p} \frac{m_k}{2} {v_k}^2 \right>
        = \sum_{k = 1}^{N_p} \frac{m_k}{2} \left< {v_k}^2 \right>
    \end{equation}

    Twierdzenie o wiriale mówi że energia kinetyczna zmienia się wskutek oddziaływań wewnętrznych i można ją 
    liczyć ze wzoru:

    \begin{equation}
        \left< E_{kinetyczna} \right>  = 
         - \frac{1}{2} \sum_{k = 1}^{N_p} \left< \vec{F_k} \cdot \vec{r_k} \right>
    \end{equation}

    \begin{equation}
        \vec{F_k} = \sum_{j = 1}^{M} \vec{{F_k}_j}
    \end{equation}
    Gdzie $M$ to liczba sąsiadów a $\vec{{F_k}_j}$ to siła oddziaływania z sąsiadem $j$-tym.

    \begin{equation}
        \left< E_{kinetyczna} \right> = 
        \sum_{k = 1}^{N_p} -\frac{1}{2} \left< \vec{F_k} \cdot \vec{r_k} \right> =
        \sum_{k = 1}^{N_p} \left< E_{kinetyczna} , k \right>
    \end{equation}
    $\left< E_{kinetyczna} , k \right>$ to suma średnich energii kinetycznych węzłów. Dla każdego węzła $k$ możemy policzyć:

    \begin{equation}
        \left< E_{kinetyczna} , k \right> = 
        -\frac{1}{2} \frac{1}{\tau} \int_{0}^{\tau} \vec{F_k}(t) \cdot \vec{r_k}(t) \, dt
    \end{equation}
    Gdzie $\tau = \Delta t \cdot n$.

    \begin{equation}
        \left< E_{kinetyczna} , k \right> = 
        -\frac{1}{2} \frac{1}{n} \sum_{j = 0}^{n} \left[  F_{kx}(t_j) \cdot x_n(t_j) + F_{ky}(t_j) \cdot y_k(t_j) \right]
    \end{equation}
    Elementy sumy zapisywane są tak samo jak poprzednio w tablicy. Przyjmujemy $n > 100$ lub więcej. 

    \begin{equation}
        \left< E_{kinetyczna, k} \right> = k_B T_k \Rightarrow T_k = \frac{\left< E_{kinetyczna, k} \right>}{k_B}
    \end{equation}
    Gdzie $k_B$ to stała Boltzmanna a $T_k$ to obliczona temperatura. \\

    Warto zwrócić uwagę na właściwości powyższego wzoru:
    \begin{enumerate}
        \item Jeśli $\vec{F_n} = 0 \Rightarrow T_k = 0$ czyli temperatura jest taka jak temperatura otoczenia.
        \item Jeśli $\left< E_{kinetyczna, k} \right> < 0 \Rightarrow T_k < 0$ oznacza że lokalna 
        temperatura stało się mniejsze niż w otoczeniu obiektu.
    \end{enumerate}

    \subsection{Algorytm obliczania}
    $\tau = \Delta t \cdot j$ dla $j = 0, 1, ..., n-1$ gdzie $\tau$ to okres czas w którym uśredniamy wyniki. \\ 
    $t = \Delta t \cdot i$ dla $i = 0, 1, ..., N_{time}$ i $t >> \tau$\\ 
    $t_{max} = \Delta t \cdot N_{time}$ gdzie $t_{max}$ to czas trwania symulacji. \\
    
    Dla każdej cząsteczki tworzymy rejestr w postaci tablicy. 
    Suma średnich energii $E_{kinetyczna}$ obliczana jest w każdej chwili czasowej.
    Aby ustabilizować rezultaty, energia kinetyczna dla węzła będzie obliczana jako 
    średnia z $n$ ostatnich chwili czasowych a ostateczna temperatura jest uśredniana dla 
    Do rejestru dostajemy się za pomocą dzielenia modulo $j = i \, \%  \, n$, które gwarantuje, 
    że nie wyjdziemy poza tablicę oraz stare wartości będą nadpisywana na bieżąco. \\

    Dodatkowo aby bardziej wygładzić wyniki kolor węzła ostateczna temperatura dla danego węzła 
    jest równa średniej z temperatur $4$ rzędów najbliższych węzłów.

    \begin{figure}[h]
        \centering
        \includegraphics[width=8cm]{avg.drawio}
        \caption{Węzły z których liczona jest średnia temperatura}
    \end{figure}

    Obliczanie temperatury przy użyciu twierdzenia o wiriale okazało się być bardziej intuicyjne i
    wyraźnie łatwiejsza w implementacji, dlatego ta metoda będzie używana w dalszej części pracy.

    % --------------------------------------------------------------------------------------------------------------
    \section{Wizualizacja ciśnienia}

    \begin{figure}[h]
        \centering
        \includegraphics[width=8cm]{pressure_box}
        \caption{Schemat komory przeznaczonej do obliczania ciśnienia na węźle}
    \end{figure}

    Węzeł otaczamy w komorze o boku $\Delta = 2 dx$ gdzie $d_0 > 10 dx$. 
    Obliczamy pochodną siły jaka oddziaływała by na węzeł gdyby został 
    on przemieszczony o $dx$ w każdym z czterech kierunków. Pochodna z siły Lennarda-Jonesa:
    \begin{equation}
        \frac{d}{dl} F_{LJ} = 3\frac{V_0}{(d_0)^2} \left[ -7 \left(\frac{d_0}{l}\right)^{8} + 13 \left(\frac{d_0}{l}\right)^{14} \right]
    \end{equation}
    
    Zgodnie z definicją ciśnienie na ściankach można opisać wzorem:
    \begin{equation}
        P_x (x \pm \frac{\Delta}{2}) = \frac{F_x (x \pm \frac{\Delta}{2})}{\Delta}
    \end{equation}
    \begin{equation}
        F_x (x + \frac{\Delta}{2}) = F_x (x) + \frac{\partial F_x}{\partial x} 
        \left| _{x + \frac{x}{2}}  \frac{x}{2} + \frac{\partial^2 F_x}{\partial x^2 }  \right| \frac{\Delta^2}{4} + O(\Delta^3)
    \end{equation}
    \begin{equation}
        F_x (x - \frac{\Delta}{2}) = F_x (x) - \frac{\partial F_x}{\partial x} 
        \left| _{x - \frac{x}{2}}  \frac{x}{2} + \frac{\partial^2 F_x}{\partial x^2 }  \right| \frac{\Delta^2}{4} + O(\Delta^3)
    \end{equation} 
    \begin{equation}
        \Delta F_x = 
        F_x (x - \frac{\Delta}{2}) - F_x (x - \frac{\Delta}{2}) = 
        \frac{\Delta}{2} \left[ \frac{\Delta F_x}{\partial x} |_{x + \frac{\Delta}{2}}  -
          \frac{\Delta F_x}{\partial x}|_{x - \frac{\Delta}{2}} \right] + O(\Delta^2)
    \end{equation}
    Dzielimy równanie przez $\Delta$
    \begin{equation}
        p_x = \frac{\Delta F_x}{\Delta} = \frac{1}{2} 
        \left[ \frac{\partial F_x}{\partial x} |_{x + \frac{\Delta}{2}} - \frac{\partial F_x}{\partial x} |_{x - \frac{\Delta}{2}} \right] + O(\Delta)
    \end{equation}
    Podobnie liczymy dla kierunku $y$
    \begin{equation}
        p_y = \frac{\Delta F_y}{\Delta} = \frac{1}{2} 
        \left[ \frac{\partial F_y}{\partial y} |_{y + \frac{\Delta}{2}} - \frac{\partial F_y}{\partial y} |_{y - \frac{\Delta}{2}} \right] + O(\Delta)
    \end{equation}
    A następnie uśredniamy:
    \begin{equation}
        p_{srednie} = \frac{1}{2} \left( -p_x - p_y \right)
    \end{equation}
    Dodajemy minus ponieważ siła jest skierowana do środka komory a ciśnienie powinno być większe od zera. 
    Dla każdego węzła trzeba policzyć pochodne siły w czterech punktach. 
    Pochodna eliminuje wpływ pola grawitacyjnego, ponieważ jest to wartość stała.

    \subsection{Testy poprawność wzoru}
    \begin{enumerate}
        \item Przypadek statyczny z jednym obiektem: Obiekt stojący na podłożu w polu grawitacyjnym.
        Większy nacisk będzie znajdować się przy podstawie obiektów.
        
        \item Przypadek dynamiczny: Uderzenie kulki w obiekt prostokątny. Największe ciśnienie 
        znajdzie się w miejscu zderzenia dwóch obiektów.

        \item Przypadek statyczny z dwoma obiektami: Dwa obiekty położone na sobie bez pola grawitacyjnego.
        Ciśnienie w środku powinno być jednorodne i takie sam jak u góry obiektu. Brzegi powinny się deformować.
    \end{enumerate}

\chapter{Testy}
    \section{Test poprawność działania algorytmów}
    \subsection{Opis testu}
    
    \begin{wrapfigure}{r}{0.45\textwidth}
        \includegraphics[width=0.9\linewidth]{objects_raw} 
        \caption{Widok aplikacji z widocznymi dwoma obiektami $8 \times 8$ oraz $6 \times 4$}
    \end{wrapfigure}
    Jeżeli wszystkie algorytmy symulujące oddziaływania fizyczne zostały zaimplementowane poprawnie 
    to w przypadku gdy nie występują żadne siły oporu energia całkowita układu powinna 
    być stała przez cały czas trwania symulacji. Aby uzyskać poprawny obraz sytuacji należy 
    uwzględnić wszystkie rodzaje energii w układzie: 
    \begin{enumerate}
        \item Energia potencjalna grawitacji
        \item Energia kinetyczna
        \item Energia potencjalna wewnątrz obiektu
        \item Energia potencjalna odpychająca pomiędzy obiektami a podłożem
        \item Energia potencjalna odpychająca pomiędzy dwoma obiektami
    \end{enumerate}

    Do testu zachowania energii wykorzystane są dwa obiekty o rozmiarach 
    odpowiednio $8 \times 8$ i $6 \times 4$ oraz statyczne podłoże. Obiekty
    znajdują się w polu grawitacyjnym, nie ma żadnych sił oporu/tarcia.

    \subsubsection{Parametry symulacji}
    \begin{align*}
        g &= 9.81 [\frac{m}{s^2}] \\
        dt &= 10^{-5} [s] \\
        t_{max} &= 8 [s]
    \end{align*}

    \subsection{Wyniki}
    \begin{figure}[h]
        \centering
        \includegraphics[width=13cm]{energy_test_0to2s}
        \caption{Zmiana energii w czasie dla układu w ciągu pierwszych 1.2 sekund}
    \end{figure}

    Przy zderzeniach pomiędzy obiektami oraz pomiędzy obiektem i podłożem energia potencjalna
    odpychająca Lennarda-Jonesa oznaczona kolejno kolorami pomarańczowym i czerwonym
    wyraźnie wzrasta.
    \begin{figure}[h]
        \centering
        \includegraphics[width=13cm]{energy_test_0to8s}
        \caption{Zmiana energii w czasie dla układu w ciągu pierwszych 8 sekund}
    \end{figure}
    
    Po upłynięciu kilku sekund obiekty zostają przy podłożu, energia będąca początkowo energią
    potencjalną grawitacji została w większości zamieniona na energię kinetyczną oraz energię
    wewnętrzną. Obiekty nie odbijają się one już między sobą.
    Zmiana energii całkowitej w czasie działania całej symulacji była mniejsza niż $1\%$. Na tej
    podstawie można uznać, że algorytmy zostały zaimplementowane poprawnie.

    % --------------------------------------------------------------------------------------------------------------
    \section{Test wydajności dla dwóch algorytmów obsługi zderzeń między obiektami}
    \subsection{Opis algorytmów}
    Naszym celem jest obliczanie siły pomiędzy odpowiednimi węzłami w taki sposób aby 
    obiekty przy zderzeniu odpychały się od siebie.
    
    \begin{figure}[h]
        \centering
        \begin{subfigure}[t]{0.45\textwidth}
            \includegraphics[width=\textwidth, height=6cm]{objects_unoptimized} 
            \caption{Każdy węzeł jednego obiektu z każdym każdym węzłem drugiego obiektu}
        \end{subfigure}
        \begin{subfigure}[t]{0.45\textwidth}
            \includegraphics[width=\textwidth, height=6cm]{objects_optimized}
            \caption{Węzły zewnętrzne jednego obiektu z węzłami zewnętrznymi drugiego obiektu}
        \end{subfigure}
        \caption{Reprezentacja dwóch metod obsługi zderzeń}
    \end{figure}

    Dla metody (a) oddziaływanie liczone jest pomiędzy każdym węzłem o kolorze niebieskim z każdym węzłem o
    kolorze pomarańczowym. Metoda o złożoności $O(n^2)$ gdzie $n$ to liczba węzłów.
    Jest to metoda bardzo wolna, lecz dająca poprawne rezultaty w każdym symulowanym przypadku.\\

    Dla metody (b) oddziaływanie ponownie liczone jest pomiędzy każdym węzłem o kolorze niebieskim z każdym
    węzłem o kolorze pomarańczowym, tym razem jednak oznaczone są jedynie węzły brzegowe.
    Metoda ta jest szczególnie efektywna dla obiektów kwadratowych o boku $n$, gdzie z $n^2$
    rozpatrywanych węzłów ta liczba jest zmniejszona do zaledwie $4(n-1)$ węzłów.
    Należy zwrócić uwagę, że metoda ta nie będzie poprawnie odwzorowywać oddziaływań dla
    obiektów zagnieżdżonych w sobie. Przykładowa sytuacja, w której algorytm nie zadziała poprawnie
    to symulacja penetracji/rozrywania obiektów.

    \subsection{Opis testu}
    Rozpatrujemy scenariusz z dwoma obiektami, sprawdzamy liczbę iteracji symulacji na sekundę stopniowo
    zwiększając liczbę węzłów w obydwóch obiektach.
    Test wydajności został wykonany na procesorze AMD Ryzen 5 5600X, 
    jest to jednowątkowa wersja algorytmu działająca na CPU.
    Ilość węzłów w bokach obiektów ustawiana jest kolejno na: 
    3, 5, 9, 10, 15, 21, 25, 30, 35, 40, 45, 50, 55, 60.
    
    \subsection{Wyniki}
    Wyniki z przeprowadzonego testu prezentują się następująco:
    \begin{figure}[H]
        \centering
        \includegraphics[width=15cm]{performance_side_size}
        \caption{
            Liczba iteracji na sekundę w zależności od 
            ilości węzłów w bokach obiektów dla dwóch metod obsługi zderzeń
        }
    \end{figure}

    \begin{table}[H]
        \centering
        \begin{tabular}{||c c c c||} 
            \hline
            węzły w boku obiektu & $iteracje / [s]$ dla (a) & $iteracje / [s]$ dla (b) & krotność przyśpieszenia \\ [0.5ex] 
            \hline\hline
            3 & 777633 & 848867 & 1.09 \\ 
            \hline
            5 & 155426 & 243030 & 1.56 \\
            \hline
            9 & 19496 & 65263 & 3.34 \\
            \hline
            15 & 2899 & 21951 & 7.57 \\
            \hline
            21 & 782 & 10798 & 13.79 \\
            \hline
            25 & 393 & 7511 & 19.06 \\
            \hline
            30 & 191 & 5128 & 26.76 \\
            \hline
            35 & 104 & 3749 & 36.00 \\
            \hline
            40 & 61 & 2777 & 45.33 \\ 
            \hline
            45 & 38 & 2232 & 58.43 \\ 
            \hline
            50 & 25 & 1801 & 71.63 \\
            \hline
            55 & 17 & 1481 & 86.11 \\ 
            \hline
            60 & 12 & 1229 & 100.88 \\ [1ex] 
            \hline
        \end{tabular}
        \caption{ Porównanie wydajności przypadku niezoptymalizowanego (a) i zoptymalizowanego (b) }
    \end{table}
    Dla większych obiektów zyski z zastosowanej optymalizacji są bardzo duże, w przypadku dwóch obiektów
    $60 \times 60$ ilość iteracji dla algorytmu zoptymalizowanego jest ponad $100$ razy większa. \\

    Duży wzrost wydajności można zrozumieć rozpatrując jeden z przypadków, na warsztat weźmy dwa 
    obiekty kwadratowe $60 \times 60$ co daje $3600$ węzłów na obiekt.
    Dla wersji niezoptymalizowanej mamy $3600 \times 3600 = 12960000$ operacji, natomiast wersja druga to zaledwie
    $4(n - 1) \times 4(n - 1) = 4(60 - 1) \times 4(60 - 1) = 236 \times 236 = 55696$ operacji. Oznacza to, że 
    w wersji każdy węzeł z każdym węzłem dla tego konkretnego przypadku musimy wykonać ponad $232$ razy więcej obliczeń
    kolizji między obiektami, gdzie zdecydowana większość z nich ma zaniedbywalny efekt na działanie symulacji. \\

    Warto zwrócić uwagę na to, że pomimo redukcji ponad $232$ razy obliczeń dla kolizji, 
    ilość iteracji symulacji na sekundę dla przypadku dwóch obiektów $60 \time 60$ wzrosła jedynie
    nieco ponad stukrotnie. Wynika to z faktu, że optymalizacja ta obejmuje jedynie etap obliczania
    kolizji między różnymi obiektami i nie wpływa na obliczanie interakcji w tym samym obiekcie,
    obliczanie wpływu pola grawitacyjnego czy obliczanie wpływu sił oporu.

    % --------------------------------------------------------------------------------------------------------------
    \section{Test rozrywania dwóch obiektów o małej ilości węzłów}
    \subsection{Opis testu}
    Dwa nieruchome obiekty, jeden zostaje umieszczony nieruchomo przy podłożu, 
    drugi znajduje się na pewnej wysokości nad obiektem pierwszym. Siła grawitacji
    jest aktywna, z tego powodu obiekt drugi zaczyna spadać na obiekt pierwszy i po chwili zderza się z nim. \\ 

    Jeżeli odległość między dwoma połączonymi węzłami zwiększy się powyżej $1.5$ odległości równowagi dla 
    tego połączenia ($d_x$), połączenie to zostaje zerwane, w ten sposób symulujemy rozrywanie obiektów pod dużym 
    obciążeniem. Do obsługi kolizji została użyta wersja algorytmu każdy węzeł z każdym węzłem, ponieważ
    działa on poprawnie dla przenikających się obiektów a przy relatywnie niewielkiej liczbie 
    węzłów ($4$ i $288$) wciąż zapewnia bardzo dobrą płynność działania animacji.

    \subsection{Parametry symulacji}
    Do symulacji zostały wykorzystane poniższe parametry:
    \begin{multicols*}{2}
        \begin{itemize}
            \item $g = 9.81$
            \item $dt = 10^{-5}$
        \end{itemize}
        Odpychanie międzyobiektowe:
        \begin{itemize}
            \item $V_{0} = 20$
            \item $d_{0} = 0.07$
        \end{itemize}
        Parametry obiektu $12 \times 24$:
        \begin{itemize}
            \item $c_{1} = 5.0$
            \item $m_{1} = 1.0$
            \item $d_{1} = 0.08$
            \item $V_{1} = 70.0$
            \item $p_{1} = [-0.92, -0.925]$
        \end{itemize}
        Parametry obiektu $2 \times 2$:
        \begin{itemize}
            \item $c_{2} = 1.0$
            \item $m_{2} = 30.0, 50.0, 80.0$
            \item $d_{2} = 0.15$
            \item $V_{2} = 500.0$
            \item $p_{2} = [-0.12, 0.8]$
        \end{itemize}
    \end{multicols*}

    Parametry $p_x$ oznaczają pozycję początkową obiektu, $m_x$ masę węzłów w obiekcie, 
    $d_x$ pozycję równowagi przyciągania/odpychania pomiędzy dwoma węzłami dla tego
    samego obiektu lub jedynie odpychania dla oddziaływań międzywęzłowych,
    $V_x$ współczynnik oddziaływania międzywęzłowego, $g$ przyśpieszenie grawitacyjne, 
    $c_x$ współczynnik oporu powietrza dla węzłów w obiekcie.

    \subsection{Wolny spadek obiektu o masie 120 kg}
    \begin{figure}[h]

        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass30_1} 
            \caption{Stan początkowy}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass30_2}
            \caption{Zderzenie}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass30_3}
            \caption{Chwila po zderzeniu}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass30_4}
            \caption{Stan stabilny}
        \end{subfigure}
        
        \caption{Zderzenie spadającego obiektu $2 \times 2$ o masie 120 kg na obiekt $12 \times 24$ o masie 288 kg}
    \end{figure}
    Masa pojedynczego węzła w wolno spadającym obiekcie wynosi 30 kg co daje łączną masę równą 120 kg.
    Węzły o kolorze czarnym mają zerową energię kinetyczną, 
    zmieniają kolor na czerwony proporcjonalnie do ilości posiadanej energii kinetycznej. 
    Przy zderzeniu widoczny jest transfer energii kinetycznej z obiektu $2 \times 2$ do obiektu $12 \times 24$, 
    w którym po chwili zaczyna rozchodzić się fala. Ze względu na zastosowanie siły oporu proporcjonalnej do prędkości
    po kilku sekundach układ stabilizuje się, obiekt $2 \times 2$ leży nieruchomo na obiekcie $12 \times 24$. 
    Żadne z połączeń międzywęzłowych nie zostało przerwane ze względu na zbyt niską energię zderzenia.

    \newpage
    \subsection{Wolny spadek obiektu o masie 200 kg}
    \begin{figure}[h]

        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass50_1} 
            \caption{Stan początkowy}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass50_2}
            \caption{Zderzenie}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass50_3}
            \caption{Chwila po zderzeniu}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass50_4}
            \caption{Stan stabilny}
        \end{subfigure}
        
        \caption{Zderzenie spadającego obiektu $2 \times 2$ o masie 200 kg na obiekt $12 \times 24$ o masie 288 kg}
    \end{figure}

    Zwiększamy masę węzłów w obiekcie $2 \times 2$ z 30 kg do 50 kg. Ponieważ w reprezentacja wizualnej węzła jego pole 
    jest proporcjonalne do jego masy, tym razem obiekt $2 \times 2$ jest większy.
    Większa energia kinetyczna przy zderzeniu powoduje przerwanie kilku połączeń międzywęzłowych, a obiekt $2 \times 2$ 
    utyka w wytworzonej dziurze. Część pierwotnego obiektu $12 \times 24$ oderwała się i utknęła w obiekcie $2 \times 2$.

    \newpage
    \subsection{Wolny spadek obiektu o masie 320 kg}
    \begin{figure}[h]

        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass80_1} 
            \caption{Stan początkowy}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass80_2}
            \caption{Zderzenie}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass80_3}
            \caption{Chwila po zderzeniu}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=6cm]{collision_2x2_24x12_mass80_4}
            \caption{Stan stabilny}
        \end{subfigure}
        
        \caption{Zderzenie spadającego obiektu $2 \times 2$ o masie 320 kg na obiekt $12 \times 24$ o masie 288 kg}
    \end{figure}

    Ponowne zwiększona została masa węzłów obiektu $2 \times 2$, tym razem z 50 kg do 80 kg, dając łączną masę 320 kg.
    W chwili zderzenia po obiekcie $12 \times 24$ rozchodzi się gwałtownie fala energii kinetycznej a on sam zostaje 
    rozerwany. Częściowemu zniszczeniu ulega również obiekt $2 \times 2$, ze względu duży stosunek masy do wytrzymałości
    połączeń międzywęzłowych niektóre z tych połączeń zostały przerwane.

    \newpage
    % --------------------------------------------------------------------------------------------------------------
    \section{Test widoku ciśnienia dla jednego obiektu}
    \subsection{Opis testu}
    Jeden obiekt o wymiarach $50 \times 50$ węzłów umieszczony zostaje przy podłożu w polu grawitacyjnym.
    Konsystencja obiektu przypomina galaretę, nie jest on sztywny. W czasie trwania symulacji 
    aktywna jest siła oporu o wysokiej wartości proporcjonalna do prędkości węzła, co powoduję szybką 
    utratę energii.

    \subsection{Reprezentacja graficzna w czasie}

    \begin{figure}[h]

        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=4.5cm]{pressure_01.png} 
            \caption{Stan początkowy}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=4.5cm]{pressure_02.png}
            \caption{Fala ciśnienia}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=4.5cm]{pressure_03.png}
            \caption{Stabilizacja}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=4.5cm]{pressure_04.png}
            \caption{Stan stabilny}
        \end{subfigure}
        
        \caption{Widok ciśnienia w wybranych chwilach czasowych dla obiektu $50 \times 50$}
    \end{figure}

    Węzły na które oddziałuje najmniejsze ciśnieniu mają kolor ciemno-niebieski, natomiast węzły na które oddziałuje 
    największe ciśnienie mają kolor czerwony. Ponieważ podczas obliczania ciśnienia bierzemy pod uwagę jedynie 
    siły oddziaływania pomiędzy połączonymi sąsiadami a węzły brzegowe mają mniej sąsiadów niż węzły znajdujące
    się w środku obiektu, to ciśnienie działające na węzły zewnętrzne będzie mniejsze niż to działające na
    węzły wewnętrzne, z czego wynika widoczne ciemno-niebieskie obramowanie obiektu. \\

    Na początku symulacji można zauważyć przemieszczającą się w górę obiektu falę ciśnienia. Wraz z czasem 
    obiekt stał się również bardziej wypukły od strony prawej i lewej ścianki
    oraz wklęsły od strony górnej ścianki. W stanie stabilnym jest on również niższy niż na początku symulacji 
    Największe ciśnienie można zaobserwować przy środku podstawy obiektu a najmniejsze przy jego 
    górnej ściance.

    \subsection{Zmiana energii układu w czasie}
    Energia całkowita układu na początku symulacji znormalizowana jest do zera. 

    \begin{figure}[H]
        \centering
        \includegraphics[width=14cm]{pressure_energy_01}
        \caption{
            Zmiana energi układu w czasie dla pierwszych 0.5 sekundy
        }
    \end{figure}

    Widoczna jest utrata energii całkowitej reprezentowanej przez linię o kolorze czarnym, która po około $0.3$ sekundy
    stabilizuje się. Energia potencjalna grawitacji również spada, co odpowiada wcześniej zaobserwowanej 
    zmniejszającej się wraz z czasem wysokości obiektu.

    \begin{figure}[H]
        \centering
        \includegraphics[width=14cm]{pressure_energy_02.png}
        \caption{
            Zmiana energi układu w czasie dla pierwszych 3.0 sekundy
        }
    \end{figure}

    Gasnące oscylacje energi potencjalnej grawitacji oraz energi potencjalnej Lennarda-Jonesa wewnątrz obiektu
    wynika z niewielkich drgań w które wpadł obiekt. Jego konsystencja przypomina galaretę, więc spodziewalibyśmy się
    oscylacji energii tego typu, jednak ze względu na istnienie siły oporu po kilku sekundach drgania te wygaszają się.


    \newpage
    % --------------------------------------------------------------------------------------------------------------
    \section{Test widoku ciśnienia dla zderzenia dwóch obiektów}
    \subsection{Opis testu}
    Jeden obiekt o wymiarach $50 \times 50$ węzłów umieszczony zostaje przy podłożu w polu grawitacyjnym a
    drugi obiekt o wymiarach $20 \times 20$ znajduje się nad obiektem pierwszym. Po krótkimi czasie pod wpływem
    działania siły grawitacji obiekt drugi zderza się z obiektem pierwszym. Aktywna jest siła oporu 
    proporcjonalna do prędkości węzła, co powoduje straty energii całkowitej układu i po pewnym czasie osiągnięcie
    stanu stabilnego.

    \subsection{Reprezentacja graficzna w czasie}

    \begin{figure}[h]

        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=5.5cm]{pressure02_01} 
            \caption{Stan początkowy}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=5.5cm]{pressure02_02}
            \caption{Przed zderzeniem}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=5.5cm]{pressure02_03}
            \caption{Zderzenie}
        \end{subfigure}
        \begin{subfigure}{0.5\textwidth}
            \centering
            \includegraphics[width=6cm, height=5.5cm]{pressure02_04}
            \caption{Stan stabilny}
        \end{subfigure}
        
        \caption{Widok ciśnienia w wybranych chwilach czasowych dla zderzenia obiektów $50 \times 50$ i $20 \times 20$}
    \end{figure}

    Przed zderzeniem największe ciśnienie w obiekcie pierwszym znajduje się na węzłach przy jego podstawie 
    a w obiekcie drugim nie występują żadne różnice ciśnień. Stan ten zmienia się w momencie zderzenia, 
    gdzie największe ciśnienie można zaobserwować w miejscu kontaktu obiektów. W stanie stabilnym 
    można zauważyć, że ze względu na niesymetryczne rozłożenie węzłów, ciśnienie przy podstawie 
    obiektu $50 \times 50$ jest wyraźnie wyższe po jego lewej stronie w porównaniu do strony prawej. \\

    Warto zwrócić uwagę że dany kolor nie jest jest bezpośrednio odwzorowywany na jedną wartość przez cały
    czas trwania symulacji. Kolorem czerwonym zawsze oznaczony jest węzeł o największej wartości a 
    kolorem ciemno-niebieskim węzeł o najmniejszej wartości. Z tego powodu na rysunku
    przedstawiającym moment zderzenia kolor węzłów przy podstawie obiektu $50 \times 50$ zmienił się z 
    czerwonego na żółty, pomimo iż wartość ciśnienia w tamtym miejscu wzrosła. Kolorem 
    czerwonym oznaczone zostały w tej chwili czasowej węzły w miejscu kontaktu obiektów, gdzie wartość 
    ciśnienia była większa niż przy podstawie obiektu $50 \times 50$.

    \subsection{Zmiana energii układu w czasie}
    Energia całkowita układu na początku symulacji znormalizowana jest do zera. 

    \begin{figure}[H]
        \centering
        \includegraphics[width=16cm]{pressure_energy02_01}
        \caption{
            Zmiana energi układu w czasie dla pierwszych 0.35 sekundy
        }
    \end{figure}
    
    Energia potencjalna grawitacji zmniejsza się ze głownie ze względu na spadający obiekt $20 \times 20$
    a ponieważ utrata energii układu jest proporcjonalna do prędkości węzłów, na początku symulacji gdy 
    obiekty są nieruchome i dopiero nabierają prędkości energia całkowita zmniejsza się w wolniejszym tempie niż 
    w późniejszym etapie symulacji, gdy węzły mają już znaczącą prędkość.

    \begin{figure}[H]
        \centering
        \includegraphics[width=16cm]{pressure_energy02_02}
        \caption{
            Zmiana energi układu w czasie dla pierwszych 1.6 sekundy
        }
    \end{figure}

    Ponieważ w tym przypadku następuje zderzenie pomiędzy obiektami energia potencjalna Lennarda-Jonesa odpychająca
    oznaczona linią o kolorze czerwonym nie jest stała i wzrasta w momencie zderzenia. W stanie spoczynku jej wartość
    jest większa niż na początku symulacji, ponieważ w stanie stabilnym obiekt $20 \times 20$ leży nieruchomo na obiekcie
    $50 \times 50$, a więc siła odpychająca między obiektami przeciwdziała sile grawitacji. 
    Wzrasta też oznaczona kolorem pomarańczowym energia odpychająca węzły od podłoża, gdyż po momencie zderzenia na 
    tym podłożu spoczywa również niebezpośrednio masa  obiektu $20 \times 20$. \\
    
    Zaobserwować można również wzrost oznaczonej linią zieloną energii międzywęzłowej wewnętrznej obiektu, wynikającej ze 
    zmniejszenia odległości pomiędzy węzłami na wskutek zgniecenia obiektu. Energia wewnętrzna wzrasta w dwóch momentach: 
    najpierw obiekt $50 \times 50$ zmienia swój kształt pod wpływem działania siły grawitacji, co powoduje zmniejszenie 
    odległości pomiędzy węzłami znajdującymi sę w nim, ten etap widoczny jest w przedziale czasu $[0, 0.6] s$. 
    Następnie w momencie $\approx 0.6 s$ następuje zderzenie powodujące wyraźne zgniecenie obiektu a zatem znaczny wzrost
    energii wewnętrznej międzywęzłowej. Energia ta po momencie zderzenia zmniejsza się na wskutek częściowego rozprężenia
    obiektów, jednak nie powraca do swojej poprzedniej wartości, ponieważ spoczywające na sobie obiekty nadal są 
    częściowo zniekształcone.

\chapter{Podsumowanie}
    \section{Wnioski}
    Zastosowanie metoda dynamiki molekularnej daje bardzo interesujące 
    wyniki podczas symulacji zderzeń obiektów. Zastosowanie dużej ilości węzłów pozwala na 
    ukazanie realistycznie wyglądających obiektów elastycznych zdolnych do kolizji między sobą 
    i rozrywających się gdy działa na nie odpowiednio duża siła. \\
    
    Konieczność wykonywania i wyświetlania symulacji z dużą ilością węzłów w czasie 
    rzeczywistym tworzy wiele problemów z wydajnością programu, wymagając
    od programisty kreatywnego podejścia do optymalizacji. Ukazuje również korzyści wynikające z 
    zastosowania zrównoleglenia algorytmów, pozwalając na wykonywanie ich znacznie znacznie szybciej na 
    urządzeniach wielowątkowych takich jak procesory czy karty graficzne.

    % --------------------------------------------------------------------------------------------------------------
    \section{Dodatek}
    \subsection{Filmik prezentujące działanie aplikacji}
    
    \subsubsection{Przekazanie energii między dwoma sztywnimi obiektami}
    \url{https://youtu.be/nolLh6CSa-8} \\

    Mniejszy obiekt $3 \times 3$ po odbiciu od większego obiektu $8 \times  8$ 
    znajdującego się  pod nim wznosi się na
    wysokość o wiele większą, niż ta z której rozpoczął spadek swobodny.
    Występuje tutaj przekazanie części energii z obiektu 
    większego do mniejszego - sama zasada energii jest zachowana.

    \subsubsection{Przekazanie energii między dwoma miękkimi obiektami}
    \url{https://youtu.be/q2uYx8uLl3w} \\

    W tym przypadku obiekty są mniej sztywne, obiekt $3 \times 3$ po odbiciu 
    od obiektu $8 \times  8$ wznosi się na wyraźnie mniejszą wysokość niż w przypadku bardziej sztywnych obiektów
    (jednak wciąż wyżej niż punkt z którego zaczął spadać). Można to wytłumaczyć tym,
    że znaczna część energii która w poprzednim przypadku była częścią ruchu postępowego,
    teraz stała się energią wewnętrzną obiektów (wibracje obiektów pochłaniają część energii).

    \subsubsection{Proste zderzenie dwóch obiektów}
    \url{https://www.youtube.com/watch?v=4cGcL_5yUt4} \\ 

    Przypadek pokazujący zderzenie dwóch obiektów nieznajdujących się w polu grawitacyjnym.
    Jednemu z obiektów nadana jest prędkość początkowa, po chwili obiekty zderzają się i 
    odbijają się od siebie.

    \subsubsection{Zderzenie obiektów 120 kg z 288 kg}
    \url{https://youtu.be/3dV6EpRacyA} \\

    Wolny spadek, brak zniszczeń obiektów.

    \subsubsection{Zderzenie obiektów 200 kg z 288 kg}
    \url{https://youtu.be/lRGl7CJiqFU} \\

    Wolny spadek, częściowe uszkodzenie jednego z obiektów.

    \subsubsection{Zderzenie obiektów 320 kg z 288 kg}
    \url{https://youtu.be/VYeCsaqNxAY} \\

    Wolny spadek, pełne zniszczenie obydwóch obiektów.

    \subsection{Repozytorium}
    \subsubsection{Link do repozytorium z kodem}
    \url{https://github.com/theYiome/elastic-objects-rs}

    \begin{thebibliography}{9}
        \bibitem{grafika3d}
        Jacek Matulewski (2014) 
        \emph{Grafika 3D czasu rzeczywistego. Nowoczesny OpenGL}, 
        Wydawnictwo Naukowe PWN SA, Wydanie I

        \bibitem{cuda}
        Shane Cook (2013) 
        \emph{CUDA Programming, a developer's guide to parallel computing with GPUs}, 
        Elsevier Inc., Morgan Kaufmann

        \bibitem{rustbook}
        Steve Klabnik, Carol Nichols (2022)
        \emph{The Rust Programming Language} \\
        \url{https://doc.rust-lang.org/book}

        \bibitem{rayon}
        Dokumentacja online biblioteki \emph{rayon 1.5.1} \\
        \url{https://docs.rs/rayon/1.5.1/rayon/}

        \bibitem{glium}
        Dokumentacja online biblioteki \emph{glium 0.30.2} \\
        \url{https://docs.rs/glium/0.30.2/glium/}

        \bibitem{egui}
        Dokumentacja online biblioteki \emph{egui 0.15.0} \\
        \url{https://docs.rs/egui/0.15.0/egui/}

    \end{thebibliography}

\end{document}